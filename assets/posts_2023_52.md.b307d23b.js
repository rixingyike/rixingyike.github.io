import{_ as a,o as p,c as l,Q as n,k as s}from"./chunks/framework.25d5caa7.js";const o="/assets/image-20231228123425880.8e4c3678.png",e="/assets/image-20231228123500292.2dc66e76.png",t="/assets/image-20231228123552215.1cce7b25.png",c="/assets/image-20231228123604913.ee4683d6.png",A=JSON.parse('{"title":"如何在微信小游戏/小游戏中获取地理位置信息？","description":"","frontmatter":{"date":"2023-12-28T12:28:19.000Z","tags":["微信开发"]},"headers":[],"relativePath":"posts/2023/52.md","filePath":"posts/2023/52.md"}'),E={name:"posts/2023/52.md"},r=n(`<h1 id="如何在微信小游戏-小游戏中获取地理位置信息" tabindex="-1">如何在微信小游戏/小游戏中获取地理位置信息？ <a class="header-anchor" href="#如何在微信小游戏-小游戏中获取地理位置信息" aria-label="Permalink to &quot;如何在微信小游戏/小游戏中获取地理位置信息？&quot;">​</a></h1><p>今天从整体上说一下小游戏/小程序中地理位置的获取。</p><p>小游戏和小程序的运行环境本质上是一类环境，只是两者在对微信接口的调用限制上，在某些方面不一样。例如在地理位置获取上，小程序有十来个接口，但小游戏只有两个，在小游戏中的运行环境中，其它接口应该也是存在的，只是被微信隐藏或屏蔽了。早期，只要两边都使用相同的设置和调用方式，接口便能调通，例如wx.getLocation便是。</p><p>后来，由于越来越多的开发商对wx.getLocation这个实时接口开始滥用，这造成了一个很严重的问题：用户手机设备上的电量被大量消耗，手机出现卡顿现象，在低端Android设备上尤其明显。于是微信开始整顿，限制开发者对地理位置服务（LBS）接口的调用。要调用该类接口，开发者必须明确说明用来干什么，提交申请，审核通过后才能被允许使用。（大概2022年6月出过一份公开声明，参见<a href="https://developers.weixin.qq.com/community/develop/doc/000a02f2c5026891650e7f40351c01%EF%BC%89" target="_blank" rel="noreferrer">https://developers.weixin.qq.com/community/develop/doc/000a02f2c5026891650e7f40351c01）</a></p><p>现在使用地理位置接口，有以下三点需要考虑：</p><p>1，在配置文件app.json（小程序）或game.json（小游戏）中，添加对scope权限的使用说明，例如：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">&quot;permission&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#79B8FF;">&quot;desc&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;display user city online&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">},</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">&quot;permission&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#005CC5;">&quot;desc&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;display user city online&quot;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">},</span></span></code></pre></div><p>这是对scope.userFuzzyLocation权限的使用说明，代码模糊的地理位置。它的旧的精确地理的权限名称是scope.userLocation。</p><p>这里的desc是展示给用户看的，</p><p>当小程序或小游戏第一次请求获得相应授权时，用户会看到一个授权弹窗：</p><p><img src="`+o+`" alt="image-20231228123425880"></p><p>desc是在这里展示给用户看的，向用户说明该开发商获取他的地理地位做什么用途。这是一个君子声明，事实上开发者获取之后做什么，用户根本不知道。</p><p>配置文件中的permission配置，只是为了设置一个将要展示给用户的一个理由，并不是说在这里设置了以后，开发者就获得了调用相关接口（例如scope.userLocation范围下的wx.getLocation接口）的权限，不是的。或者说，原来是这样，现在微信团队加强了管理，不再是的。</p><p>2，在配置文件中添加一个requiredPrivateInfos配置节点，使用哪个接口，就把对应接口的名字填上。例如：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">&quot;requiredPrivateInfos&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;getFuzzyLocation&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">&quot;requiredPrivateInfos&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;getFuzzyLocation&quot;</span></span>
<span class="line"><span style="color:#24292E;">]</span></span></code></pre></div><p>我们准备调用wx.getFuzzyLocation接口，所以把它写在这里。这个配置原来是不需要的，后来出于对用户个人私密信息的加强保护，在scope权限配置指向不明确的情况下，又添加这个配置。例如scope.userLocation范围下，有以下三个接口：</p><p><img src="`+e+`" alt="image-20231228123500292"></p><p>仅是配置scope，微信不知道开发者要调用哪个接口，于是就有这个配置节点。</p><p>3，有了前面两步并不意味着可以获取地理位置信息了，在获取该信息之前，需要申请。</p><p>在小程序中，需要在“小程序管理后台 -「开发」-「开发管理」-「接口设置」” 中完成权限申请。在小游戏中，目前不需要这个申请页面。所以，对于小游戏，</p><p>wx.getLocation接口的权限被官方默认收回了。官方建议使用wx.getFuzzyLocation代替对wx.getLocation的使用，在开发者工具中我们也可以看到，wx.getLocation被划了删除线，它已经被建议舍弃了。这个改变是从 2022 年 7 月 14 日起生效的。旧的应用不受影响，新的应用按新的规矩办。</p><p>在《微信小游戏开发》后端篇中，有一个LBSManager，它需要一些修改，在修改后是这样的：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> QQMapJSSDK </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;../libs/qqmap-wx-jssdk.min.js&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> {promisify} </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;../utils.js&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">QQ_LBS_KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;L5YBZ-BTZHX-FPU42-Z3PUL-VHHG2-*****&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">LBSManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">city</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.#city;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">#city</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;unknown&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">#qqmapsdk</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">QQMapJSSDK</span><span style="color:#E1E4E8;">({ key: </span><span style="color:#79B8FF;">QQ_LBS_KEY</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">options</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.initialized) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">; </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.initialized </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        wx.</span><span style="color:#B392F0;">getSetting</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">authSetting</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> res.authSetting;</span></span>
<span class="line"><span style="color:#E1E4E8;">                console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(authSetting);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">authSetting[</span><span style="color:#9ECBFF;">&quot;scope.userLocation&quot;</span><span style="color:#E1E4E8;">]) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    wx.</span><span style="color:#B392F0;">authorize</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">                        scope: </span><span style="color:#9ECBFF;">&quot;scope.userLocation&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">#updateCity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                        },</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">fail</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(err);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    })</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">#updateCity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        })</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    #</span><span style="color:#B392F0;">updateCity</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;start to get city&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        wx.</span><span style="color:#B392F0;">getLocation</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">            type: </span><span style="color:#9ECBFF;">&quot;gcj02&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            altitude: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.#qqmapsdk.</span><span style="color:#B392F0;">reverseGeocoder</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">                    location: {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        latitude: res.latitude,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        longitude:res.longitude</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(res);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.#city </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> res.result.address_component.city;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">fail</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span></span>
<span class="line"><span style="color:#E1E4E8;">                        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(err);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                })</span></span>
<span class="line"><span style="color:#E1E4E8;">            },</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">fail</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;getLocation fail&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(res);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        })</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SyncLBSManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">city</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.city;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">#city</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;unknown&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">#qqmapsdk</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">QQMapJSSDK</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">        key: </span><span style="color:#79B8FF;">QQ_LBS_KEY</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">options</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">res</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> wx.</span><span style="color:#B392F0;">getSetting</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">res.authSetting[</span><span style="color:#9ECBFF;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#E1E4E8;">]) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> wx.</span><span style="color:#B392F0;">authorize</span><span style="color:#E1E4E8;">({ scope: </span><span style="color:#9ECBFF;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#E1E4E8;"> }).</span><span style="color:#B392F0;">catch</span><span style="color:#E1E4E8;">(console.log);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">#updateCity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> #</span><span style="color:#B392F0;">updateCity</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">res</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">promisify</span><span style="color:#E1E4E8;">(wx.getFuzzyLocation)({</span></span>
<span class="line"><span style="color:#E1E4E8;">            type: </span><span style="color:#9ECBFF;">&quot;gcj02&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            altitude: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">        }).</span><span style="color:#B392F0;">catch</span><span style="color:#E1E4E8;">(console.log);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">lbsRes</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">promisify</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.#qqmapsdk.reverseGeocoder.</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">bind</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.#qqmapsdk))({</span></span>
<span class="line"><span style="color:#E1E4E8;">                location: </span><span style="color:#9ECBFF;">\`\${</span><span style="color:#E1E4E8;">res</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">latitude</span><span style="color:#9ECBFF;">},\${</span><span style="color:#E1E4E8;">res</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">longitude</span><span style="color:#9ECBFF;">}\`</span></span>
<span class="line"><span style="color:#E1E4E8;">            }).</span><span style="color:#B392F0;">catch</span><span style="color:#E1E4E8;">(console.log);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.#city </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> lbsRes.result.address_component.city;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SyncLBSManager</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> QQMapJSSDK </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;../libs/qqmap-wx-jssdk.min.js&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> {promisify} </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;../utils.js&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">QQ_LBS_KEY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;L5YBZ-BTZHX-FPU42-Z3PUL-VHHG2-*****&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">LBSManager</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">get</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">city</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.#city;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">#city</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;unknown&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">#qqmapsdk</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">QQMapJSSDK</span><span style="color:#24292E;">({ key: </span><span style="color:#005CC5;">QQ_LBS_KEY</span><span style="color:#24292E;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">(</span><span style="color:#E36209;">options</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!!</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.initialized) </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">; </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.initialized </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        wx.</span><span style="color:#6F42C1;">getSetting</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: (</span><span style="color:#E36209;">res</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">authSetting</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> res.authSetting;</span></span>
<span class="line"><span style="color:#24292E;">                console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(authSetting);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">authSetting[</span><span style="color:#032F62;">&quot;scope.userLocation&quot;</span><span style="color:#24292E;">]) {</span></span>
<span class="line"><span style="color:#24292E;">                    wx.</span><span style="color:#6F42C1;">authorize</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">                        scope: </span><span style="color:#032F62;">&quot;scope.userLocation&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: </span><span style="color:#E36209;">res</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">#updateCity</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                        },</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">fail</span><span style="color:#24292E;">: </span><span style="color:#E36209;">err</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                            console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(err);</span></span>
<span class="line"><span style="color:#24292E;">                        }</span></span>
<span class="line"><span style="color:#24292E;">                    })</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">#updateCity</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        })</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    #</span><span style="color:#6F42C1;">updateCity</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;start to get city&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        wx.</span><span style="color:#6F42C1;">getLocation</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">            type: </span><span style="color:#032F62;">&quot;gcj02&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            altitude: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: </span><span style="color:#E36209;">res</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.#qqmapsdk.</span><span style="color:#6F42C1;">reverseGeocoder</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">                    location: {</span></span>
<span class="line"><span style="color:#24292E;">                        latitude: res.latitude,</span></span>
<span class="line"><span style="color:#24292E;">                        longitude:res.longitude</span></span>
<span class="line"><span style="color:#24292E;">                    },</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: </span><span style="color:#E36209;">res</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(res);</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.#city </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> res.result.address_component.city;</span></span>
<span class="line"><span style="color:#24292E;">                    },</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">fail</span><span style="color:#24292E;">: </span><span style="color:#E36209;">err</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                       </span></span>
<span class="line"><span style="color:#24292E;">                        console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(err);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                })</span></span>
<span class="line"><span style="color:#24292E;">            },</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">fail</span><span style="color:#24292E;">: </span><span style="color:#E36209;">res</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;getLocation fail&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(res);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        })</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SyncLBSManager</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">get</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">city</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.city;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">#city</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;unknown&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">#qqmapsdk</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">QQMapJSSDK</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">        key: </span><span style="color:#005CC5;">QQ_LBS_KEY</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">(</span><span style="color:#E36209;">options</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">res</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> wx.</span><span style="color:#6F42C1;">getSetting</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">res.authSetting[</span><span style="color:#032F62;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#24292E;">]) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> wx.</span><span style="color:#6F42C1;">authorize</span><span style="color:#24292E;">({ scope: </span><span style="color:#032F62;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#24292E;"> }).</span><span style="color:#6F42C1;">catch</span><span style="color:#24292E;">(console.log);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">#updateCity</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">async</span><span style="color:#24292E;"> #</span><span style="color:#6F42C1;">updateCity</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">res</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">promisify</span><span style="color:#24292E;">(wx.getFuzzyLocation)({</span></span>
<span class="line"><span style="color:#24292E;">            type: </span><span style="color:#032F62;">&quot;gcj02&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            altitude: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">        }).</span><span style="color:#6F42C1;">catch</span><span style="color:#24292E;">(console.log);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">lbsRes</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">promisify</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.#qqmapsdk.reverseGeocoder.</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.#qqmapsdk))({</span></span>
<span class="line"><span style="color:#24292E;">                location: </span><span style="color:#032F62;">\`\${</span><span style="color:#24292E;">res</span><span style="color:#032F62;">.</span><span style="color:#24292E;">latitude</span><span style="color:#032F62;">},\${</span><span style="color:#24292E;">res</span><span style="color:#032F62;">.</span><span style="color:#24292E;">longitude</span><span style="color:#032F62;">}\`</span></span>
<span class="line"><span style="color:#24292E;">            }).</span><span style="color:#6F42C1;">catch</span><span style="color:#24292E;">(console.log);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.#city </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> lbsRes.result.address_component.city;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SyncLBSManager</span><span style="color:#24292E;">();</span></span></code></pre></div><p>配置文件game.json也需要一些个性，修改后是：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;deviceOrientation&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;portrait&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;permission&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&quot;desc&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;display user city online&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;requiredPrivateInfos&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;getFuzzyLocation&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;deviceOrientation&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;portrait&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;permission&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;scope.userFuzzyLocation&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;desc&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;display user city online&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;requiredPrivateInfos&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;getFuzzyLocation&quot;</span></span>
<span class="line"><span style="color:#24292E;">  ]</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在进行地理位置功能开发的时候，可能会遇到下面这些问题：</p><p>1，在手机上测试</p><p>电脑有时候虽然也能获取当前所在的地理位置，但开发者工具作为一个测试开发环境，它没有实现这方面的功能。如果在电脑上测试，会遇到这样的问题：</p>`,28),y=s("blockquote",{"errMsg:":"","getFuzzyLocation:fail开发者工具暂时不支持此API调试，请使用真机进行开发":""},[s("p")],-1),i=n('<p>解决办法：在手机设备上测试或调试。</p><p><img src="'+t+'" alt="image-20231228123552215"></p><p>在手机设备上调用wx.getFuzzyLocation成功，会返回getFuzzyLocation:ok。</p><p>2，wx.getFuzzyLocation不是有效函数</p><p>基础库版本号过低，在项目设置中选择1.7以上的版本号。</p><p>3，看不到授权窗口</p><p>正常情况下，用户第一次打开应用，会看到一个弹窗：</p><p><img src="'+c+'" alt="image-20231228123604913"></p><p>如果没有这个弹窗，可能因为没有使用接口wx.authorize进行提前授权。在测试开发时，可以通过在开发者工具中清除所有缓存，让这个弹窗再次出现。</p><p>4，访问被拒绝</p><p>错误信息：</p><blockquote><p>getLocation:fail:access denied</p></blockquote><p>解决办法：使用wx.authorize重新拉取授权，或在小程序管理后台提交地理位置权限申请。</p><p>5，不被充许</p><p>错误信息：</p><blockquote><p>errMsg: &quot;getLocation:fail no permission&quot;</p></blockquote><p>解决办法：完成上面三步中的前两步，申请并获得权限允可，同时告知用户接口用意。</p><p>大概就是以上这些，有问题欢迎再提出来～</p>',18),F=[r,y,i];function u(d,g,q,C,B,h){return p(),l("div",null,F)}const _=a(E,[["render",u]]);export{A as __pageData,_ as default};
